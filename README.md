# Генерация и сортировка больших текстовых файлов

Файл содержит строки формата: `<Number part>. <String part>`
Принцип сортировки - сначала сравнивается стороковая часть, затем численная.

# Описание работы алгоритма
Сортировка производится в два этапа:
1. Разбиение файла на части и сортировка отдельных частей:
    * Класс SourceFileReader последовательно читает исходный файл и десериализует строки в объектное представление (Entry).
    * По мере накопления достаточного количества объектов Entry, формируется их множество (Chunk) и отдается на обработку одному из объектов ChunkProcessor. Общее количество объектов ChunkProcessor равно количеству ядер процессора.
    * ChunkProcessor в отдельном потоке запускает in-memory сортировку Chunk и сохраняет отсортированное множество во временное хранилище (SortedChunksStorage). Используется сортировка heapsort, сложность O(n log(n)).
    * Когда весь исходный файл прочитан - SourceFileReader дожидается окончания сортировки всех оставшихся частей.
  
2. Склеивание отсортированных подмножеств в результирующий файл:
    * SortedChunksStorage возвращает массив десериалиаторов (EntryReader) отсортированных множеств. Каждый EntryReader может последовательно перемещаться по множеству от начала до конца, возращая текущий элемент через свойство Current.
    * На основе первых значений всех EntryReader строится бинарное дерево (min heap).
    * Производится извлечение и запись в результирующий файл минимального Entry из текущего состояния бинарного дерева. Сложность O(n log(n)).
    * EntryReader, из которого было получено минимальное значение, переводится на следующую запись, бинарное дерево перебалансируется. Сложность O(n log(n)).
    * Предыдущие два шага повторяются до тех пор, пока хотя бы в одном из EntryReader есть значения.
  
Общая сложность алгоритма **O(n log(n))**.

# Оптимизация производительности
Для обеспечения высокой скорости сортировки используются следующие техники:
  * Распараллеливание CPU-bound и IO-bound операций
  * Распараллеливание CPU-bound операций по всем ядрам процессора
  * Минимизированы аллокации объектов в куче путем использования Span и ArrayPool
  * Промежуточное сжатие временных файлов для минимизации операций ввода-вывода
  * Буферизация потоков ввода-вывода
  * Агрессивный режим сборки мусора (GcServer + Batch Latency mode)
  
# Параметры запуска генератора тестовых файлов

**sort100gen output=<output_file> [--size=<file_size_in_Gb>]**

Например: sort100gen output=c:/test-1gb.txt --size=1

# Параметры запуска сортировки

**sort100 input=<input_file> [output=<output_file>]**

Например: sort100 input=c:/test-1gb.txt output=d:/test-1gb.txt

При запуске сортировки желательно располагать файл-результат на быстром диске (SSD) и иметь не менее 8Gb свободной памяти.

# Тестирование производительности
![Performance](/perf.png)
